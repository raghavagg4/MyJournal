{% extends "header.html" %}
{% block content %}
<div class="flex h-screen bg-gray-50 overflow-hidden">
    <!-- Sidebar -->
    <div class="w-64 border-r bg-white flex flex-col h-full">
        <div class="p-4 border-b">
            <a href="{{ url_for('users.journal') }}" class="block w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline text-center">New Entry</a>
        </div>
        <div class="flex-1 overflow-y-auto" id="entries-container">
            {% if entries %}
                {% for entry in entries %}
                    <div class="m-2 cursor-pointer hover:bg-gray-100 bg-white rounded-lg shadow-md">
                        <a href="{{ url_for('users.journal', entry_id=entry.id) }}" class="block">
                            <div class="p-3">
                                <div class="font-semibold truncate">{{ entry.title }}</div>
                                <div class="text-xs text-gray-500">{{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center p-4 text-gray-500">
                    <p>No entries yet</p>
                </div>
            {% endif %}
            <div id="loading-indicator" class="hidden text-center p-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden">
        <div class="flex-1 p-6 overflow-y-auto">
            <div class="h-full max-w-4xl mx-auto w-full">
                <form method="POST" action="{% if selected_entry %}{{ url_for('users.journal', entry_id=selected_entry.id) }}{% else %}{{ url_for('users.journal') }}{% endif %}" class="h-full flex flex-col">
                    {{ form.csrf_token }}

                    <div class="mb-4">
                        {{ form.title(class="shadow appearance-none border rounded w-full py-2 px-3 text-xl font-medium focus:outline-none focus:shadow-outline", placeholder="Title...") }}
                        {% if form.title.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="flex-1 mb-4">
                        {{ form.content(class="h-full rounded-xl p-4 text-base shadow appearance-none border w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline", placeholder="Start writing your thoughts here...") }}
                        {% if form.content.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in form.content.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-between">
                        {{ form.submit(class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline") }}

                        {% if selected_entry %}
                            <form method="POST" action="{{ url_for('users.delete_entry', entry_id=selected_entry.id) }}" class="inline" onsubmit="return confirm('Are you sure you want to delete this entry?');">
                                <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    Delete
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let isLoading = false;
let hasMoreEntries = {{ has_next|tojson }};

function loadMoreEntries() {
    if (isLoading || !hasMoreEntries) return;
    
    isLoading = true;
    currentPage++;
    
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.classList.remove('hidden');
    
    fetch(`{{ url_for('users.journal') }}?page=${currentPage}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        const entriesContainer = document.getElementById('entries-container');
        
        data.entries.forEach(entry => {
            const entryHtml = `
                <div class="m-2 cursor-pointer hover:bg-gray-100 bg-white rounded-lg shadow-md">
                    <a href="{{ url_for('users.journal') }}/${entry.id}" class="block">
                        <div class="p-3">
                            <div class="font-semibold truncate">${entry.title}</div>
                            <div class="text-xs text-gray-500">${new Date(entry.created_at).toLocaleString()}</div>
                        </div>
                    </a>
                </div>
            `;
            entriesContainer.insertAdjacentHTML('beforeend', entryHtml);
        });
        
        hasMoreEntries = data.has_next;
        loadingIndicator.classList.add('hidden');
        isLoading = false;
    })
    .catch(error => {
        console.error('Error loading more entries:', error);
        loadingIndicator.classList.add('hidden');
        isLoading = false;
    });
}

// Add scroll event listener to the entries container
const entriesContainer = document.getElementById('entries-container');
entriesContainer.addEventListener('scroll', () => {
    const { scrollTop, scrollHeight, clientHeight } = entriesContainer;
    if (scrollHeight - scrollTop <= clientHeight + 100) { // Load more when 100px from bottom
        loadMoreEntries();
    }
});
</script>
{% endblock %}
